// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --prefix-filecheck-ir-name TMP_ --version 5

// RUN: %clang_cc1 -fbounds-safety -ast-dump -fbounds-safety-bringup-missing-checks=indirect_count_update -DWITH %s 2>&1 | FileCheck %s
// RUN: %clang_cc1 -fbounds-safety -ast-dump -fno-bounds-safety-bringup-missing-checks=indirect_count_update %s 2>&1 | FileCheck --check-prefix WITHOUT %s
#include <ptrcheck.h>

// CHECK: |-FunctionDecl [[func_foo:0x[^ ]+]] {{.+}} foo
// CHECK: | |-ParmVarDecl [[var_x:0x[^ ]+]]
// CHECK: | |-ParmVarDecl [[var_count:0x[^ ]+]]
// CHECK: | | `-DependerDeclsAttr
// CHECK: | `-CompoundStmt
// CHECK: |   |-BinaryOperator {{.+}} 'int' '='
// CHECK: |   | |-UnaryOperator {{.+}} cannot overflow
// CHECK: |   | | `-MaterializeSequenceExpr {{.+}} <Bind>
// CHECK: |   | |   |-BoundsCheckExpr {{.+}} 'x + 1UL <= __builtin_get_pointer_upper_bound(x + 1UL) && __builtin_get_pointer_lower_bound(x + 1UL) <= x + 1UL && count - 1U <= __builtin_get_pointer_upper_bound(x + 1UL) - x + 1UL'
// CHECK: |   | |   | |-UnaryOperator {{.+}} postfix '++'
// CHECK: |   | |   | | `-OpaqueValueExpr [[ove:0x[^ ]+]] {{.*}} lvalue
// CHECK: |   | |   | `-BinaryOperator {{.+}} 'int' '&&'
// CHECK: |   | |   |   |-BinaryOperator {{.+}} 'int' '&&'
// CHECK: |   | |   |   | |-BinaryOperator {{.+}} 'int' '<='
// CHECK: |   | |   |   | | |-ImplicitCastExpr {{.+}} 'int *' <BoundsSafetyPointerCast>
// CHECK: |   | |   |   | | | `-OpaqueValueExpr [[ove_1:0x[^ ]+]] {{.*}} 'int *__bidi_indexable'
// CHECK: |   | |   |   | | |     | | | |-OpaqueValueExpr [[ove_2:0x[^ ]+]] {{.*}} 'int *__single __counted_by(count)':'int *__single'
// CHECK: |   | |   |   | | |     | | | | `-OpaqueValueExpr [[ove_3:0x[^ ]+]] {{.*}} 'unsigned int'
// CHECK: |   | |   |   | | `-GetBoundExpr {{.+}} upper
// CHECK: |   | |   |   | |   `-OpaqueValueExpr [[ove_1]] {{.*}} 'int *__bidi_indexable'
// CHECK: |   | |   |   | `-BinaryOperator {{.+}} 'int' '<='
// CHECK: |   | |   |   |   |-GetBoundExpr {{.+}} lower
// CHECK: |   | |   |   |   | `-OpaqueValueExpr [[ove_1]] {{.*}} 'int *__bidi_indexable'
// CHECK: |   | |   |   |   `-ImplicitCastExpr {{.+}} 'int *' <BoundsSafetyPointerCast>
// CHECK: |   | |   |   |     `-OpaqueValueExpr [[ove_1]] {{.*}} 'int *__bidi_indexable'
// CHECK: |   | |   |   `-BinaryOperator {{.+}} 'int' '<='
// CHECK: |   | |   |     |-ImplicitCastExpr {{.+}} 'long' <IntegralCast>
// CHECK: |   | |   |     | `-OpaqueValueExpr [[ove_4:0x[^ ]+]] {{.*}} 'unsigned int'
// CHECK: |   | |   |     |     | `-OpaqueValueExpr [[ove_5:0x[^ ]+]] {{.*}} lvalue
// CHECK: |   | |   |     `-BinaryOperator {{.+}} 'long' '-'
// CHECK: |   | |   |       |-GetBoundExpr {{.+}} upper
// CHECK: |   | |   |       | `-OpaqueValueExpr [[ove_1]] {{.*}} 'int *__bidi_indexable'
// CHECK: |   | |   |       `-ImplicitCastExpr {{.+}} 'int *' <BoundsSafetyPointerCast>
// CHECK: |   | |   |         `-OpaqueValueExpr [[ove_1]] {{.*}} 'int *__bidi_indexable'
// CHECK: |   | |   |-OpaqueValueExpr [[ove]]
// CHECK: |   | |   | `-DeclRefExpr {{.+}} [[var_x]]
// CHECK: |   | |   |-OpaqueValueExpr [[ove_1]]
// CHECK: |   | |   | `-BinaryOperator {{.+}} 'int *__bidi_indexable' '+'
// CHECK: |   | |   |   |-MaterializeSequenceExpr {{.+}} <Unbind>
// CHECK: |   | |   |   | |-MaterializeSequenceExpr {{.+}} <Bind>
// CHECK: |   | |   |   | | |-BoundsSafetyPointerPromotionExpr {{.+}} 'int *__bidi_indexable'
// CHECK: |   | |   |   | | | |-OpaqueValueExpr [[ove_2]] {{.*}} 'int *__single __counted_by(count)':'int *__single'
// CHECK: |   | |   |   | | | |-BinaryOperator {{.+}} 'int *' '+'
// CHECK: |   | |   |   | | | | |-ImplicitCastExpr {{.+}} 'int *' <BoundsSafetyPointerCast>
// CHECK: |   | |   |   | | | | | `-OpaqueValueExpr [[ove_2]] {{.*}} 'int *__single __counted_by(count)':'int *__single'
// CHECK: |   | |   |   | | | | `-OpaqueValueExpr [[ove_3]] {{.*}} 'unsigned int'
// CHECK: |   | |   |   | | |-OpaqueValueExpr [[ove_2]]
// CHECK: |   | |   |   | | | `-ImplicitCastExpr {{.+}} 'int *__single __counted_by(count)':'int *__single' <LValueToRValue>
// CHECK: |   | |   |   | | |   `-OpaqueValueExpr [[ove]] {{.*}} lvalue
// CHECK: |   | |   |   | | `-OpaqueValueExpr [[ove_3]]
// CHECK: |   | |   |   | |   `-ImplicitCastExpr {{.+}} 'unsigned int' <LValueToRValue>
// CHECK: |   | |   |   | |     `-DeclRefExpr {{.+}} [[var_count]]
// CHECK: |   | |   |   | |-OpaqueValueExpr [[ove_2]] {{.*}} 'int *__single __counted_by(count)':'int *__single'
// CHECK: |   | |   |   | `-OpaqueValueExpr [[ove_3]] {{.*}} 'unsigned int'
// CHECK: |   | |   |   `-IntegerLiteral {{.+}} 1
// CHECK: |   | |   |-OpaqueValueExpr [[ove_5]]
// CHECK: |   | |   | `-DeclRefExpr {{.+}} [[var_count]]
// CHECK: |   | |   `-OpaqueValueExpr [[ove_4]]
// CHECK: |   | |     `-BinaryOperator {{.+}} 'unsigned int' '-'
// CHECK: |   | |       |-ImplicitCastExpr {{.+}} 'unsigned int' <LValueToRValue>
// CHECK: |   | |       | `-OpaqueValueExpr [[ove_5]] {{.*}} lvalue
// CHECK: |   | |       `-IntegerLiteral {{.+}} 1
// CHECK: |   | `-IntegerLiteral {{.+}} 0
// CHECK: |   `-MaterializeSequenceExpr {{.+}} <Unbind>
// CHECK: |     |-UnaryOperator {{.+}} postfix '--'
// CHECK: |     | `-OpaqueValueExpr [[ove_5]] {{.*}} lvalue
// CHECK: |     |-OpaqueValueExpr [[ove]] {{.*}} lvalue
// CHECK: |     |-OpaqueValueExpr [[ove_1]] {{.*}} 'int *__bidi_indexable'
// CHECK: |     |-OpaqueValueExpr [[ove_5]] {{.*}} lvalue
// CHECK: |     `-OpaqueValueExpr [[ove_4]] {{.*}} 'unsigned int'

// WITHOUT: |-FunctionDecl [[func_foo:0x[^ ]+]] {{.+}} foo
// WITHOUT-NEXT: | |-ParmVarDecl [[var_x:0x[^ ]+]]
// WITHOUT-NEXT: | |-ParmVarDecl [[var_count:0x[^ ]+]]
// WITHOUT-NEXT: | | `-DependerDeclsAttr
// WITHOUT-NEXT: | `-CompoundStmt
// WITHOUT-NEXT: |   `-BinaryOperator {{.+}} 'int' '='
// WITHOUT-NEXT: |     |-UnaryOperator {{.+}} cannot overflow
// WITHOUT-NEXT: |     | `-UnaryOperator {{.+}} postfix '++'
// WITHOUT-NEXT: |     |   `-DeclRefExpr {{.+}} [[var_x]]
// WITHOUT-NEXT: |     `-IntegerLiteral {{.+}} 0
void foo(int *__counted_by(count) x, unsigned count) {
	*x++ = 0;
    #ifdef WITH
    // NOTE: It's necessary to exclude the count update with
    // indirect_count_update disabled otherwise we'll get diagnostics about
    // the a missing assignment to `x`.
    count--;
    #endif
}

// CHECK:      {{^}}`-FunctionDecl [[func_bar:0x[^ ]+]] {{.+}} bar
// CHECK-NEXT: {{^}}  |-ParmVarDecl [[var_x_1:0x[^ ]+]]
// CHECK-NEXT: {{^}}  |-ParmVarDecl [[var_count_1:0x[^ ]+]]
// CHECK-NEXT: {{^}}  | `-DependerDeclsAttr
// CHECK-NEXT: {{^}}  `-CompoundStmt
// CHECK-NEXT: {{^}}    |-MaterializeSequenceExpr {{.+}} <Bind>
// CHECK-NEXT: {{^}}    | |-BoundsCheckExpr {{.+}} 'x + 1 <= __builtin_get_pointer_upper_bound(x + 1) && __builtin_get_pointer_lower_bound(x + 1) <= x + 1 && count - 1 <= __builtin_get_pointer_upper_bound(x + 1) - x + 1 && 0 <= count - 1'
// CHECK-NEXT: {{^}}    | | |-BinaryOperator {{.+}} 'int' '='
// CHECK-NEXT: {{^}}    | | | |-DeclRefExpr {{.+}} [[var_count_1]]
// CHECK-NEXT: {{^}}    | | | `-OpaqueValueExpr [[ove_6:0x[^ ]+]] {{.*}} 'int'
// CHECK:      {{^}}    | | `-BinaryOperator {{.+}} 'int' '&&'
// CHECK-NEXT: {{^}}    | |   |-BinaryOperator {{.+}} 'int' '&&'
// CHECK-NEXT: {{^}}    | |   | |-BinaryOperator {{.+}} 'int' '<='
// CHECK-NEXT: {{^}}    | |   | | |-ImplicitCastExpr {{.+}} 'int *' <BoundsSafetyPointerCast>
// CHECK-NEXT: {{^}}    | |   | | | `-OpaqueValueExpr [[ove_7:0x[^ ]+]] {{.*}} 'int *__bidi_indexable'
// CHECK:      {{^}}    | |   | | |     | | | |-OpaqueValueExpr [[ove_8:0x[^ ]+]] {{.*}} 'int *__single __counted_by(count)':'int *__single'
// CHECK:      {{^}}    | |   | | |     | | | | `-OpaqueValueExpr [[ove_9:0x[^ ]+]] {{.*}} 'int'
// CHECK:      {{^}}    | |   | | `-GetBoundExpr {{.+}} upper
// CHECK-NEXT: {{^}}    | |   | |   `-OpaqueValueExpr [[ove_7]] {{.*}} 'int *__bidi_indexable'
// CHECK:      {{^}}    | |   | `-BinaryOperator {{.+}} 'int' '<='
// CHECK-NEXT: {{^}}    | |   |   |-GetBoundExpr {{.+}} lower
// CHECK-NEXT: {{^}}    | |   |   | `-OpaqueValueExpr [[ove_7]] {{.*}} 'int *__bidi_indexable'
// CHECK:      {{^}}    | |   |   `-ImplicitCastExpr {{.+}} 'int *' <BoundsSafetyPointerCast>
// CHECK-NEXT: {{^}}    | |   |     `-OpaqueValueExpr [[ove_7]] {{.*}} 'int *__bidi_indexable'
// CHECK:      {{^}}    | |   `-BinaryOperator {{.+}} 'int' '&&'
// CHECK-NEXT: {{^}}    | |     |-BinaryOperator {{.+}} 'int' '<='
// CHECK-NEXT: {{^}}    | |     | |-ImplicitCastExpr {{.+}} 'long' <IntegralCast>
// CHECK-NEXT: {{^}}    | |     | | `-OpaqueValueExpr [[ove_6]] {{.*}} 'int'
// CHECK:      {{^}}    | |     | `-BinaryOperator {{.+}} 'long' '-'
// CHECK-NEXT: {{^}}    | |     |   |-GetBoundExpr {{.+}} upper
// CHECK-NEXT: {{^}}    | |     |   | `-OpaqueValueExpr [[ove_7]] {{.*}} 'int *__bidi_indexable'
// CHECK:      {{^}}    | |     |   `-ImplicitCastExpr {{.+}} 'int *' <BoundsSafetyPointerCast>
// CHECK-NEXT: {{^}}    | |     |     `-OpaqueValueExpr [[ove_7]] {{.*}} 'int *__bidi_indexable'
// CHECK:      {{^}}    | |     `-BinaryOperator {{.+}} 'int' '<='
// CHECK-NEXT: {{^}}    | |       |-IntegerLiteral {{.+}} 0
// CHECK-NEXT: {{^}}    | |       `-OpaqueValueExpr [[ove_6]] {{.*}} 'int'
// CHECK:      {{^}}    | |-OpaqueValueExpr [[ove_6]]
// CHECK-NEXT: {{^}}    | | `-BinaryOperator {{.+}} 'int' '-'
// CHECK-NEXT: {{^}}    | |   |-ImplicitCastExpr {{.+}} 'int' <LValueToRValue>
// CHECK-NEXT: {{^}}    | |   | `-DeclRefExpr {{.+}} [[var_count_1]]
// CHECK-NEXT: {{^}}    | |   `-IntegerLiteral {{.+}} 1
// CHECK-NEXT: {{^}}    | `-OpaqueValueExpr [[ove_7]]
// CHECK-NEXT: {{^}}    |   `-BinaryOperator {{.+}} 'int *__bidi_indexable' '+'
// CHECK-NEXT: {{^}}    |     |-MaterializeSequenceExpr {{.+}} <Unbind>
// CHECK-NEXT: {{^}}    |     | |-MaterializeSequenceExpr {{.+}} <Bind>
// CHECK-NEXT: {{^}}    |     | | |-BoundsSafetyPointerPromotionExpr {{.+}} 'int *__bidi_indexable'
// CHECK-NEXT: {{^}}    |     | | | |-OpaqueValueExpr [[ove_8]] {{.*}} 'int *__single __counted_by(count)':'int *__single'
// CHECK:      {{^}}    |     | | | |-BinaryOperator {{.+}} 'int *' '+'
// CHECK-NEXT: {{^}}    |     | | | | |-ImplicitCastExpr {{.+}} 'int *' <BoundsSafetyPointerCast>
// CHECK-NEXT: {{^}}    |     | | | | | `-OpaqueValueExpr [[ove_8]] {{.*}} 'int *__single __counted_by(count)':'int *__single'
// CHECK:      {{^}}    |     | | | | `-OpaqueValueExpr [[ove_9]] {{.*}} 'int'
// CHECK:      {{^}}    |     | | |-OpaqueValueExpr [[ove_8]]
// CHECK-NEXT: {{^}}    |     | | | `-ImplicitCastExpr {{.+}} 'int *__single __counted_by(count)':'int *__single' <LValueToRValue>
// CHECK-NEXT: {{^}}    |     | | |   `-DeclRefExpr {{.+}} [[var_x_1]]
// CHECK-NEXT: {{^}}    |     | | `-OpaqueValueExpr [[ove_9]]
// CHECK-NEXT: {{^}}    |     | |   `-ImplicitCastExpr {{.+}} 'int' <LValueToRValue>
// CHECK-NEXT: {{^}}    |     | |     `-DeclRefExpr {{.+}} [[var_count_1]]
// CHECK-NEXT: {{^}}    |     | |-OpaqueValueExpr [[ove_8]] {{.*}} 'int *__single __counted_by(count)':'int *__single'
// CHECK:      {{^}}    |     | `-OpaqueValueExpr [[ove_9]] {{.*}} 'int'
// CHECK:      {{^}}    |     `-IntegerLiteral {{.+}} 1
// CHECK-NEXT: {{^}}    `-BinaryOperator {{.+}} 'int' '='
// CHECK-NEXT: {{^}}      |-UnaryOperator {{.+}} cannot overflow
// CHECK-NEXT: {{^}}      | `-ParenExpr
// CHECK-NEXT: {{^}}      |   `-MaterializeSequenceExpr {{.+}} <Unbind>
// CHECK-NEXT: {{^}}      |     |-BinaryOperator {{.+}} 'int *__single __counted_by(count)':'int *__single' '='
// CHECK-NEXT: {{^}}      |     | |-DeclRefExpr {{.+}} [[var_x_1]]
// CHECK-NEXT: {{^}}      |     | `-ImplicitCastExpr {{.+}} 'int *__single __counted_by(count)':'int *__single' <BoundsSafetyPointerCast>
// CHECK-NEXT: {{^}}      |     |   `-OpaqueValueExpr [[ove_7]] {{.*}} 'int *__bidi_indexable'
// CHECK:      {{^}}      |     |-OpaqueValueExpr [[ove_6]] {{.*}} 'int'
// CHECK:      {{^}}      |     `-OpaqueValueExpr [[ove_7]] {{.*}} 'int *__bidi_indexable'
// CHECK:      {{^}}      `-IntegerLiteral {{.+}} 0

// WITHOUT-NEXT: {{^}}`-FunctionDecl [[func_bar:0x[^ ]+]] {{.+}} bar
// WITHOUT-NEXT: {{^}}  |-ParmVarDecl [[var_x_1:0x[^ ]+]]
// WITHOUT-NEXT: {{^}}  |-ParmVarDecl [[var_count_1:0x[^ ]+]]
// WITHOUT-NEXT: {{^}}  | `-DependerDeclsAttr
// WITHOUT-NEXT: {{^}}  `-CompoundStmt
// WITHOUT-NEXT: {{^}}    `-BinaryOperator {{.+}} 'int' '='
// WITHOUT-NEXT: {{^}}      |-UnaryOperator {{.+}} cannot overflow
// WITHOUT-NEXT: {{^}}      | `-ParenExpr
// WITHOUT-NEXT: {{^}}      |   `-BinaryOperator {{.+}} 'int *__single __counted_by(count)':'int *__single' '='
// WITHOUT-NEXT: {{^}}      |     |-DeclRefExpr {{.+}} [[var_x_1]]
// WITHOUT-NEXT: {{^}}      |     `-ImplicitCastExpr {{.+}} 'int *__single __counted_by(count)':'int *__single' <BoundsSafetyPointerCast>
// WITHOUT-NEXT: {{^}}      |       `-BinaryOperator {{.+}} 'int *__bidi_indexable' '+'
// WITHOUT-NEXT: {{^}}      |         |-MaterializeSequenceExpr {{.+}} <Unbind>
// WITHOUT-NEXT: {{^}}      |         | |-MaterializeSequenceExpr {{.+}} <Bind>
// WITHOUT-NEXT: {{^}}      |         | | |-BoundsSafetyPointerPromotionExpr {{.+}} 'int *__bidi_indexable'
// WITHOUT-NEXT: {{^}}      |         | | | |-OpaqueValueExpr [[ove:0x[^ ]+]] {{.*}} 'int *__single __counted_by(count)':'int *__single'
// WITHOUT:      {{^}}      |         | | | |-BinaryOperator {{.+}} 'int *' '+'
// WITHOUT-NEXT: {{^}}      |         | | | | |-ImplicitCastExpr {{.+}} 'int *' <BoundsSafetyPointerCast>
// WITHOUT-NEXT: {{^}}      |         | | | | | `-OpaqueValueExpr [[ove]] {{.*}} 'int *__single __counted_by(count)':'int *__single'
// WITHOUT:      {{^}}      |         | | | | `-OpaqueValueExpr [[ove_1:0x[^ ]+]] {{.*}} 'int'
// WITHOUT:      {{^}}      |         | | |-OpaqueValueExpr [[ove]]
// WITHOUT-NEXT: {{^}}      |         | | | `-ImplicitCastExpr {{.+}} 'int *__single __counted_by(count)':'int *__single' <LValueToRValue>
// WITHOUT-NEXT: {{^}}      |         | | |   `-DeclRefExpr {{.+}} [[var_x_1]]
// WITHOUT-NEXT: {{^}}      |         | | `-OpaqueValueExpr [[ove_1]]
// WITHOUT-NEXT: {{^}}      |         | |   `-ImplicitCastExpr {{.+}} 'int' <LValueToRValue>
// WITHOUT-NEXT: {{^}}      |         | |     `-DeclRefExpr {{.+}} [[var_count_1]]
// WITHOUT-NEXT: {{^}}      |         | |-OpaqueValueExpr [[ove]] {{.*}} 'int *__single __counted_by(count)':'int *__single'
// WITHOUT:      {{^}}      |         | `-OpaqueValueExpr [[ove_1]] {{.*}} 'int'
// WITHOUT:      {{^}}      |         `-IntegerLiteral {{.+}} 1
// WITHOUT-NEXT: {{^}}      `-IntegerLiteral {{.+}} 0

void bar(int *__counted_by(count) x, int count) {
    #ifdef WITH
    // NOTE: It's necessary to exclude the count update with
    // indirect_count_update disabled otherwise we'll get diagnostics about
    // the a missing assignment to `x`.
    count = count - 1;
    #endif
	*(x = x+1) = 0;
}
