// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --prefix-filecheck-ir-name TMP_ --version 5

// RUN: %clang_cc1 -triple x86_64 -fbounds-safety -emit-llvm -O2 -fbounds-safety-bringup-missing-checks=indirect_count_update %s -o - | FileCheck %s
// RUN: %clang_cc1 -triple x86_64 -fbounds-safety -emit-llvm -O2 -fno-bounds-safety-bringup-missing-checks=indirect_count_update %s -o - | FileCheck --check-prefix WITHOUT %s
#include <ptrcheck.h>

// CHECK-LABEL: define dso_local void @foo(
// CHECK-SAME: ptr noundef writeonly [[START:%.*]], ptr noundef writeonly [[END:%.*]]) local_unnamed_addr #[[ATTR0:[0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:    [[BOUND_PTR_ARITH:%.*]] = getelementptr i8, ptr [[END]], i64 -4
// CHECK-NEXT:    [[BOUND_PTR_ARITH3:%.*]] = getelementptr i8, ptr [[START]], i64 4
// CHECK-NEXT:    [[CMP_NOT:%.*]] = icmp ugt ptr [[BOUND_PTR_ARITH]], [[END]], !annotation [[META2:![0-9]+]]
// CHECK-NEXT:    [[CMP22_NOT:%.*]] = icmp ugt ptr [[BOUND_PTR_ARITH3]], [[BOUND_PTR_ARITH]], !annotation [[META2]]
// CHECK-NEXT:    [[OR_COND:%.*]] = or i1 [[CMP_NOT]], [[CMP22_NOT]], !annotation [[META2]]
// CHECK-NEXT:    [[CMP33_NOT:%.*]] = icmp ult ptr [[BOUND_PTR_ARITH3]], [[START]], !annotation [[META2]]
// CHECK-NEXT:    [[OR_COND41:%.*]] = or i1 [[CMP33_NOT]], [[OR_COND]], !annotation [[META2]]
// CHECK-NEXT:    br i1 [[OR_COND41]], label %[[TRAP:.*]], label %[[CONT:.*]], !annotation [[META2]]
// CHECK:       [[TRAP]]:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR2:[0-9]+]], !annotation [[META2]]
// CHECK-NEXT:    unreachable, !annotation [[META2]]
// CHECK:       [[CONT]]:
// CHECK-NEXT:    store i32 0, ptr [[END]], align 4, !tbaa [[TBAA3:![0-9]+]]
// CHECK-NEXT:    store i32 0, ptr [[START]], align 4, !tbaa [[TBAA3]]
// CHECK-NEXT:    ret void
//
// WITHOUT-LABEL: define dso_local void @foo(
// WITHOUT-SAME: ptr nocapture noundef writeonly [[START:%.*]], ptr nocapture noundef writeonly [[END:%.*]]) local_unnamed_addr #[[ATTR0:[0-9]+]] {
// WITHOUT-NEXT:  [[ENTRY:.*:]]
// WITHOUT-NEXT:    store i32 0, ptr [[END]], align 4, !tbaa [[TBAA2:![0-9]+]]
// WITHOUT-NEXT:    store i32 0, ptr [[START]], align 4, !tbaa [[TBAA2]]
// WITHOUT-NEXT:    ret void
//
void foo(int *__ended_by(end) start, int * end) {
    *end-- = 0;
	*start++ = 0;
}

// CHECK-LABEL: define dso_local void @bar(
// CHECK-SAME: ptr noundef writeonly [[START:%.*]], ptr noundef writeonly [[END:%.*]]) local_unnamed_addr #[[ATTR0]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:    [[BOUND_PTR_ARITH:%.*]] = getelementptr i8, ptr [[START]], i64 4
// CHECK-NEXT:    [[BOUND_PTR_ARITH3:%.*]] = getelementptr i8, ptr [[END]], i64 -4
// CHECK-NEXT:    [[CMP_NOT:%.*]] = icmp ugt ptr [[BOUND_PTR_ARITH3]], [[END]], !annotation [[META2]]
// CHECK-NEXT:    [[CMP22_NOT:%.*]] = icmp ugt ptr [[BOUND_PTR_ARITH]], [[BOUND_PTR_ARITH3]], !annotation [[META2]]
// CHECK-NEXT:    [[OR_COND:%.*]] = or i1 [[CMP_NOT]], [[CMP22_NOT]], !annotation [[META2]]
// CHECK-NEXT:    [[CMP33_NOT:%.*]] = icmp ult ptr [[BOUND_PTR_ARITH]], [[START]], !annotation [[META2]]
// CHECK-NEXT:    [[OR_COND52:%.*]] = or i1 [[CMP33_NOT]], [[OR_COND]], !annotation [[META2]]
// CHECK-NEXT:    br i1 [[OR_COND52]], label %[[TRAP:.*]], label %[[CONT:.*]], !annotation [[META2]]
// CHECK:       [[TRAP]]:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR2]], !annotation [[META2]]
// CHECK-NEXT:    unreachable, !annotation [[META2]]
// CHECK:       [[CONT]]:
// CHECK-NEXT:    store i32 0, ptr [[BOUND_PTR_ARITH]], align 4, !tbaa [[TBAA3]]
// CHECK-NEXT:    store i32 0, ptr [[BOUND_PTR_ARITH3]], align 4, !tbaa [[TBAA3]]
// CHECK-NEXT:    ret void
//
// WITHOUT-LABEL: define dso_local void @bar(
// WITHOUT-SAME: ptr nocapture noundef writeonly [[START:%.*]], ptr nocapture noundef writeonly [[END:%.*]]) local_unnamed_addr #[[ATTR0]] {
// WITHOUT-NEXT:  [[ENTRY:.*:]]
// WITHOUT-NEXT:    [[BOUND_PTR_ARITH:%.*]] = getelementptr i8, ptr [[START]], i64 4
// WITHOUT-NEXT:    store i32 0, ptr [[BOUND_PTR_ARITH]], align 4, !tbaa [[TBAA2]]
// WITHOUT-NEXT:    [[BOUND_PTR_ARITH3:%.*]] = getelementptr i8, ptr [[END]], i64 -4
// WITHOUT-NEXT:    store i32 0, ptr [[BOUND_PTR_ARITH3]], align 4, !tbaa [[TBAA2]]
// WITHOUT-NEXT:    ret void
//
void bar(int *__ended_by(end) start, int * end) {
	*(start = start+1) = 0;
    *(end = end-1) = 0;
}
//.
// CHECK: [[META2]] = !{!"bounds-safety-generic"}
// CHECK: [[TBAA3]] = !{[[META4:![0-9]+]], [[META4]], i64 0}
// CHECK: [[META4]] = !{!"int", [[META5:![0-9]+]], i64 0}
// CHECK: [[META5]] = !{!"omnipotent char", [[META6:![0-9]+]], i64 0}
// CHECK: [[META6]] = !{!"Simple C/C++ TBAA"}
//.
// WITHOUT: [[TBAA2]] = !{[[META3:![0-9]+]], [[META3]], i64 0}
// WITHOUT: [[META3]] = !{!"int", [[META4:![0-9]+]], i64 0}
// WITHOUT: [[META4]] = !{!"omnipotent char", [[META5:![0-9]+]], i64 0}
// WITHOUT: [[META5]] = !{!"Simple C/C++ TBAA"}
//.
