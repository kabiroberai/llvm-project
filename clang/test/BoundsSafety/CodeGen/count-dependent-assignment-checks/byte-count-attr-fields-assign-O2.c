// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py

// RUN: %clang_cc1 -O2 -triple x86_64 -fbounds-safety -emit-llvm %s -o - | FileCheck %s --check-prefix=CHECK

#include <ptrcheck.h>

struct S {
    int *__sized_by(l) bp;
    int *bp2 __sized_by(l+4);
    int l;
};

// CHECK-LABEL: @foo(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    ret void
//
void foo () {
    int arr[10];
    struct S s = {arr, arr, 0};
    s.bp = &arr[1];
    s.bp2 = arr;
    s.l = 9 * sizeof(int); // no trap
}

// CHECK-LABEL: @bar(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR3:[0-9]+]], !annotation !{{.*}}
// CHECK-NEXT:    unreachable
//
void bar () {
    int arr[10];
    struct S s = {arr, arr, 0};
    int n = 10 * sizeof(int);
    s.bp = &arr[1];
    s.bp2 = arr;
    s.l = n; // trap s.l > bounds of (s.bp)
}
